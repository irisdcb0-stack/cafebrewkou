<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="KOU COFE - Tu carrito de compras">
    <title>KOU COFE â€” Carrito</title>
    
    <!-- Preconnect for faster font loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Styles and favicon -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/cart.css">
    <link rel="icon" type="image/png" href="img/favicon.png">
</head>
<body>
    <header class="site-header">
        <div class="brand">
            <a href="index.html" aria-label="KOU COFE Inicio">KOU COFE</a>
        </div>
        <nav class="nav" aria-label="NavegaciÃ³n principal">
            <button class="nav-toggle" 
                    aria-label="Abrir menÃº" 
                    aria-expanded="false"
                    aria-controls="nav-list">â˜°</button>
            <ul class="nav-list" id="nav-list">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="tienda.html">Tienda</a></li>
                <li><a href="historial.html">Historial</a></li>
                <li><a href="nosotros.html">Nosotros</a></li>
                <li><a href="contacto.html">Contacto</a></li>
            </ul>
        </nav>
        <a class="cart-link" href="carrito.html" aria-current="page" aria-label="Ver carrito de compras">
            ðŸ›’ <span id="cart-count" aria-live="polite">0</span>
        </a>
    </header>

    <main class="cart-main">
        <h1 class="page-title">Tu Carrito</h1>
        
        <div class="cart-container">
            <table class="cart-table" id="cart-table">
                <thead>
                    <tr>
                        <th scope="col">Producto</th>
                        <th scope="col">Precio</th>
                        <th scope="col" aria-label="Acciones"></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Cart items will be loaded here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="cart-total" id="cart-total">Total: $0.00</td>
                    </tr>
                </tfoot>
            </table>

            <div class="cart-actions">
                <button class="btn secondary" onclick="window.location.href='tienda.html'">
                    Seguir Comprando
                </button>
                <button class="btn primary" id="checkout-btn" aria-haspopup="dialog">
                    Proceder al Pago
                </button>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="payment-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modal-title">
            <div class="modal-overlay" role="presentation"></div>
            <div class="modal-content">
                <button class="modal-close" aria-label="Cerrar" onclick="modal.style.display='none'">&times;</button>
                <h2 id="modal-title">Finalizar Compra</h2>
                
                <form id="payment-form" class="payment-form">
                    <div class="form-group">
                        <label for="card-name">Nombre en la tarjeta</label>
                        <input type="text" id="card-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="card-number">NÃºmero de tarjeta</label>
                        <input type="text" id="card-number" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-expiry">Fecha de expiraciÃ³n</label>
                            <input type="text" id="card-expiry" required 
                                   placeholder="MM/YY">
                        </div>
                        
                        <div class="form-group">
                            <label for="card-cvv">CVV</label>
                            <input type="text" id="card-cvv" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="shipping-address">DirecciÃ³n de envÃ­o</label>
                        <textarea id="shipping-address" required 
                                  rows="3"
                                  autocomplete="street-address"
                                  aria-required="true"></textarea>
                    </div>
                    
                    <button type="submit" class="btn primary">Confirmar Pago</button>
                </form>
            </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="modal success" aria-hidden="true" role="alert">
            <div class="modal-content">
                <div class="success-icon">âœ“</div>
                <h2>Â¡Compra Exitosa!</h2>
                <p>Tu pedido ha sido procesado correctamente.</p>
                <button class="btn primary" onclick="goHome()">Volver al Inicio</button>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="footer-inner">
            <p>El arte del cafÃ© en tus manos â˜•</p>
            <div class="socials">
                <a href="#" target="_blank" rel="noopener noreferrer" 
                   aria-label="SÃ­guenos en Instagram">Instagram</a> â€¢ 
                <a href="#" target="_blank" rel="noopener noreferrer" 
                   aria-label="SÃ­guenos en Facebook">Facebook</a> â€¢ 
                <a href="#" target="_blank" rel="noopener noreferrer" 
                   aria-label="SÃ­guenos en Twitter">Twitter</a>
            </div>
            <p>Â© <span id="year">2023</span> KOU COFE</p>
        </div>
    </footer>

    <script>
        const tableBody = document.querySelector("#cart-table tbody");
        const totalEl = document.getElementById("cart-total");
        const modal = document.getElementById("payment-modal");
        const form = document.getElementById("payment-form");
        const success = document.getElementById("success-message");
        const checkoutBtn = document.getElementById("checkout-btn");

        // Load cart from localStorage
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        
        // Update cart count in header
        document.getElementById('cart-count').textContent = cart.length;

        function renderCart() {
            tableBody.innerHTML = "";
            let total = 0;

            if (cart.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-cart">
                            <p>Tu carrito estÃ¡ vacÃ­o ðŸ›’</p>
                            <button class="btn secondary" onclick="window.location.href='tienda.html'">
                                Ir a la Tienda
                            </button>
                        </td>
                    </tr>`;
                checkoutBtn.disabled = true;
            } else {
                cart.forEach((item, i) => {
                    total += item.price;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${item.name}</td>
                        <td>$${item.price.toFixed(2)}</td>
                        <td>
                            <button class="remove" 
                                    onclick="removeItem(${i})"
                                    aria-label="Eliminar ${item.name} del carrito">âœ–</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                checkoutBtn.disabled = false;
            }

            totalEl.textContent = `Total: $${total.toFixed(2)}`;
        }

        function removeItem(index) {
            const item = cart[index];
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            document.getElementById('cart-count').textContent = cart.length;
            renderCart();
            
            // Show feedback
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = `${item.name} eliminado del carrito`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Payment modal handling
        checkoutBtn.addEventListener("click", () => {
            if (cart.length === 0) {
                alert("Tu carrito estÃ¡ vacÃ­o");
                return;
            }
            modal.style.display = "flex";
            modal.setAttribute('aria-hidden', 'false');
            document.getElementById('card-name').focus();
        });

        // Form submission
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Procesando...';

            try {
                // Simulate payment processing
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Save order to history
                const orders = JSON.parse(localStorage.getItem('orders')) || [];
                const newOrder = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    items: cart,
                    total: cart.reduce((sum, item) => sum + item.price, 0),
                    status: "En proceso",
                    shippingAddress: document.getElementById('shipping-address').value
                };
                orders.push(newOrder);
                localStorage.setItem('orders', JSON.stringify(orders));

                // Clear cart
                localStorage.removeItem('cart');
                cart = [];
                document.getElementById('cart-count').textContent = '0';

                // Show success message
                modal.style.display = "none";
                modal.setAttribute('aria-hidden', 'true');
                success.style.display = "flex";
                success.setAttribute('aria-hidden', 'false');

                // Reset form
                form.reset();
                
            } catch (error) {
                alert('Error al procesar el pago. Por favor intenta nuevamente.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirmar Pago';
            }
        });

        // Close modal when clicking outside
        modal.querySelector('.modal-overlay').addEventListener('click', () => {
            modal.style.display = "none";
            modal.setAttribute('aria-hidden', 'true');
        });

        // ESC key closes modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                modal.style.display = "none";
                modal.setAttribute('aria-hidden', 'true');
            }
        });

        function goHome() {
            window.location.href = "index.html";
        }

        // Initialize
        renderCart();
        document.getElementById("year").textContent = new Date().getFullYear();
    </script>
</body>
</html>
